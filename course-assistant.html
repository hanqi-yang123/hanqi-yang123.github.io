<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹</title>
    <!-- Font Awesome å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF.jsåº“ç”¨äºè§£æPDFæ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- KaTeXåº“ç”¨äºæ¸²æŸ“LaTeXå…¬å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§å¯¹è¯åˆ—è¡¨ */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .review-btn {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(243,156,18,0.3);
        }

        .review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243,156,18,0.4);
        }

        /* æ–‡ä»¶å¤¹æ ·å¼ */
        .folder-section {
            margin-bottom: 5px;
        }

        .folder-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.15);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 3px;
            gap: 8px;
        }

        .folder-header:hover {
            background: rgba(0,0,0,0.25);
        }

        .folder-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .folder-icon.expanded {
            transform: rotate(90deg);
        }

        .folder-name {
            flex: 1;
            font-size: 13px;
            color: #ecf0f1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-name-input {
            flex: 1;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 4px;
            color: #fff;
            padding: 2px 6px;
            font-size: 13px;
        }

        .folder-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .folder-header:hover .folder-actions {
            opacity: 1;
        }

        .folder-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 2px 5px;
        }

        .folder-btn:hover {
            color: #fff;
        }

        .folder-btn.delete:hover {
            color: #ff6b6b;
        }

        .folder-chats {
            padding-left: 15px;
            display: none;
        }

        .folder-chats.expanded {
            display: block;
        }

        .new-folder-btn {
            width: 100%;
            padding: 8px 15px;
            background: transparent;
            color: rgba(255,255,255,0.6);
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .new-folder-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border-color: rgba(255,255,255,0.5);
        }

        .chat-item {
            padding: 10px 12px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-item:hover {
            background: rgba(255,255,255,0.25);
        }

        .chat-item.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-item-title {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-item-title-input {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 4px;
            color: #fff;
            padding: 2px 6px;
            font-size: 13px;
            min-width: 0;
        }

        .chat-item-actions {
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-item:hover .chat-item-actions {
            opacity: 1;
        }

        .chat-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 3px 5px;
            font-size: 12px;
        }

        .chat-btn:hover {
            color: #fff;
        }

        .chat-btn.delete:hover {
            color: #ff6b6b;
        }

        /* ç§»åŠ¨å¯¹è¯å¼¹çª— */
        .move-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .move-modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
            max-width: 400px;
        }

        .move-modal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .move-modal-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .move-modal-item {
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
            background: #f8f9fa;
            transition: background 0.2s;
        }

        .move-modal-item:hover {
            background: #e9ecef;
        }

        .move-modal-item.active {
            background: #3498db;
            color: #fff;
        }

        .move-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .move-modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .move-modal-btn.cancel {
            background: #e9ecef;
            color: #333;
        }

        .move-modal-btn.confirm {
            background: #3498db;
            color: #fff;
        }

        .chat-item-delete {
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            color: #e74c3c;
        }

        /* å³ä¾§ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            min-width: 0;
        }

        /* é¡¶éƒ¨æ•™æåŒºåŸŸ */
        .textbook-area {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .textbook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .textbook-header h3 {
            font-size: 14px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .textbook-upload-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 10px rgba(39,174,96,0.3);
        }

        .textbook-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39,174,96,0.4);
        }

        .textbook-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .textbook-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            color: #495057;
        }

        .textbook-item-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 14px;
        }

        .textbook-empty {
            color: #6c757d;
            font-size: 13px;
            font-style: italic;
        }

        /* å¯¹è¯åŒºåŸŸ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .message.assistant .message-content {
            background: #f1f3f4;
            color: #333;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
        }

        .message-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content code {
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .welcome-message h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #495057;
        }

        .welcome-message p {
            font-size: 14px;
            margin-bottom: 8px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .input-preview {
            margin-bottom: 10px;
        }

        .preview-image {
            position: relative;
            display: inline-block;
        }

        .preview-image img {
            max-height: 100px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .preview-image-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .image-upload-btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .image-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .text-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .text-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-hint {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
            box-shadow: 0 3px 10px rgba(243,156,18,0.3);
        }

        .btn-hint:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243,156,18,0.4);
        }

        .btn-correct {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
            box-shadow: 0 3px 10px rgba(231,76,60,0.3);
        }

        .btn-correct:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231,76,60,0.4);
        }

        .btn-generate {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: #fff;
            box-shadow: 0 3px 10px rgba(155,89,182,0.3);
        }

        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155,89,182,0.4);
        }

        .btn-ask {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            flex: 1;
            min-width: 120px;
            box-shadow: 0 3px 10px rgba(102,126,234,0.3);
        }

        .btn-ask:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .loading span {
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        .hidden-input {
            display: none;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Markdownæ¸²æŸ“æ ·å¼ */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 15px 0 10px 0;
        }

        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content p {
            margin: 8px 0;
        }

        .message-content blockquote {
            border-left: 3px solid #3498db;
            padding-left: 12px;
            margin: 10px 0;
            color: #666;
        }

        /* LaTeXå…¬å¼æ ·å¼ */
        .message-content .katex-block {
            display: block;
            text-align: center;
            margin: 15px 0;
            overflow-x: auto;
            padding: 10px 0;
        }

        .message-content .katex {
            font-size: 1.1em;
        }

        .message-content .katex-display {
            margin: 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
        .mobile-sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
            transition: all 0.3s;
        }

        .mobile-sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102,126,234,0.5);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.show {
                left: 0;
            }

            .mobile-sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .message-content {
                max-width: 85%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .textbook-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .input-row {
                flex-direction: column;
            }

            .image-upload-btn {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢ -->
    <button class="mobile-sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="container">
        <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-robot"></i> AIè¯¾ç¨‹åŠ©æ‰‹</h2>
                <button class="new-chat-btn" onclick="createNewChat()"><i class="fas fa-plus"></i> æ–°å»ºå¯¹è¯</button>
            </div>
            <div class="chat-list" id="chatList">
                <button class="new-folder-btn" onclick="createNewFolder()"><i class="fas fa-folder-plus"></i> æ–°å»ºæ–‡ä»¶å¤¹</button>
                <!-- å¯¹è¯åˆ—è¡¨é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="sidebar-footer">
                <button class="review-btn" onclick="window.open('review.html', '_blank')"><i class="fas fa-history"></i> é—®é¢˜å›é¡¾</button>
            </div>
        </div>

        <!-- ç§»åŠ¨å¯¹è¯å¼¹çª— -->
        <div class="move-modal" id="moveModal" style="display: none;">
            <div class="move-modal-content">
                <div class="move-modal-title">ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹</div>
                <div class="move-modal-list" id="moveModalList"></div>
                <div class="move-modal-buttons">
                    <button class="move-modal-btn cancel" onclick="closeMoveModal()">å–æ¶ˆ</button>
                    <button class="move-modal-btn confirm" onclick="confirmMove()">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- æ•™æä¸Šä¼ åŒºåŸŸ -->
            <div class="textbook-area">
                <div class="textbook-header">
                    <h3><i class="fas fa-book-open"></i> å‚è€ƒæ•™æ</h3>
                    <button class="textbook-upload-btn" onclick="document.getElementById('textbookInput').click()">
                        <i class="fas fa-upload"></i> ä¸Šä¼ æ•™æ
                    </button>
                    <input type="file" id="textbookInput" class="hidden-input" accept=".md,.tex,.txt,.pdf" onchange="handleTextbookUpload(event)">
                </div>
                <div class="textbook-list" id="textbookList">
                    <span class="textbook-empty">æš‚æœªä¸Šä¼ æ•™æï¼Œä¸Šä¼ åAIå°†åŸºäºæ•™æå†…å®¹è¿›è¡Œè®²è§£</span>
                </div>
            </div>

            <!-- å¯¹è¯åŒºåŸŸ -->
            <div class="chat-area" id="chatArea">
                <div class="welcome-message">
                    <h2>æ¬¢è¿ä½¿ç”¨AIè¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹</h2>
                    <p>ä¸Šä¼ æ‚¨çš„æ•™ææ–‡ä»¶ï¼ˆMarkdown/LaTeX/PDFï¼‰ï¼Œæˆ‘å°†åŸºäºæ•™æå†…å®¹ä¸ºæ‚¨ç­”ç–‘è§£æƒ‘</p>
                    <p>æ‚¨å¯ä»¥ä¸Šä¼ é¢˜ç›®å›¾ç‰‡æˆ–è¾“å…¥é—®é¢˜ï¼Œé€‰æ‹©ä¸åŒåŠŸèƒ½è·å–å¸®åŠ©ï¼š</p>
                    <p><strong>æç¤º</strong> - ç»™å‡ºè§£é¢˜æ€è·¯ï¼Œä¸ç›´æ¥ç»™ç­”æ¡ˆ</p>
                    <p><strong>æ‰¹æ”¹</strong> - æ£€æŸ¥æ‚¨çš„ç­”æ¡ˆï¼ŒæŒ‡å‡ºé”™è¯¯å¹¶è®²è§£</p>
                    <p><strong>ç”Ÿé¢˜</strong> - ç”Ÿæˆç±»ä¼¼çš„ç»ƒä¹ é¢˜ç›®</p>
                    <p><strong>è‡ªç”±é—®</strong> - è‡ªç”±æé—®ä»»ä½•å­¦ä¹ é—®é¢˜</p>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-preview" id="inputPreview"></div>
                <div class="input-row">
                    <button class="image-upload-btn" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-image"></i> ä¸Šä¼ å›¾ç‰‡
                    </button>
                    <input type="file" id="imageInput" class="hidden-input" accept="image/*" onchange="handleImageUpload(event)">
                    <textarea class="text-input" id="textInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–é¢˜ç›®å†…å®¹..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-hint" onclick="sendMessage('hint')" id="btnHint"><i class="fas fa-lightbulb"></i> æç¤º</button>
                    <button class="action-btn btn-correct" onclick="sendMessage('correct')" id="btnCorrect"><i class="fas fa-check-circle"></i> æ‰¹æ”¹</button>
                    <button class="action-btn btn-generate" onclick="sendMessage('generate')" id="btnGenerate"><i class="fas fa-magic"></i> ç”Ÿé¢˜</button>
                    <button class="action-btn btn-ask" onclick="sendMessage('ask')" id="btnAsk"><i class="fas fa-paper-plane"></i> è‡ªç”±é—®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_KEY = 'ms-95e9fbc7-e55d-4d1f-927a-c9d33fe73a78';
        const API_URL = 'https://api-inference.modelscope.cn/v1/chat/completions';

        // åº”ç”¨çŠ¶æ€
        let state = {
            folders: [],  // æ–‡ä»¶å¤¹åˆ—è¡¨
            chats: [],
            currentChatId: null,
            textbooks: [],
            currentImage: null,
            isLoading: false,
            expandedFolders: {},  // å±•å¼€çŠ¶æ€
            editingChatId: null,  // æ­£åœ¨ç¼–è¾‘çš„å¯¹è¯ID
            editingFolderId: null,  // æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶å¤¹ID
            movingChatId: null,  // æ­£åœ¨ç§»åŠ¨çš„å¯¹è¯ID
            selectedMoveTarget: null  // ç§»åŠ¨ç›®æ ‡æ–‡ä»¶å¤¹ID
        };

        // åˆå§‹åŒ–
        function init() {
            loadState();
            renderChatList();
            if (state.chats.length === 0) {
                createNewChat();
            } else {
                selectChat(state.currentChatId || state.chats[0].id);
            }
            renderTextbooks();
        }

        // çŠ¶æ€æŒä¹…åŒ–
        function saveState() {
            localStorage.setItem('courseAssistantState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('courseAssistantState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.folders = parsed.folders || [];
                state.chats = parsed.chats || [];
                state.currentChatId = parsed.currentChatId;
                state.textbooks = parsed.textbooks || [];
                state.expandedFolders = parsed.expandedFolders || {};
            }
        }

        // ä¿å­˜é—®é¢˜è®°å½•åˆ°é—®é¢˜å›é¡¾
        function saveQuestionRecord(question, image, answer, action) {
            // åªä¿å­˜æœ‰å®é™…é—®é¢˜å†…å®¹çš„è®°å½•
            if (!question && !image) return;
            
            const records = JSON.parse(localStorage.getItem('questionRecords') || '[]');
            
            // è·å–å½“å‰å¯¹è¯çš„æ–‡ä»¶å¤¹
            const chat = getCurrentChat();
            const folder = chat && chat.folderId ? state.folders.find(f => f.id === chat.folderId) : null;
            
            // ç”Ÿæˆç®€çŸ­æ‘˜è¦
            let summary = '';
            if (question) {
                summary = question.slice(0, 50) + (question.length > 50 ? '...' : '');
            } else if (image) {
                summary = '[å›¾ç‰‡é—®é¢˜]';
            }
            
            const record = {
                id: Date.now().toString(),
                question: question,
                image: image,
                answer: answer,
                summary: summary,
                action: action,
                folderName: folder ? folder.name : null,  // ä¿å­˜æ–‡ä»¶å¤¹åç§°
                createdAt: new Date().toISOString(),
                isMarked: false  // æ˜¯å¦æ ‡è®°ä¸ºé‡ç‚¹/é”™é¢˜
            };
            
            records.unshift(record);
            
            // æœ€å¤šä¿å­˜100æ¡è®°å½•
            if (records.length > 100) {
                records.pop();
            }
            
            localStorage.setItem('questionRecords', JSON.stringify(records));
        }

        // æ–‡ä»¶å¤¹ç®¡ç†
        function createNewFolder() {
            const folder = {
                id: Date.now().toString(),
                name: 'æ–°æ–‡ä»¶å¤¹',
                createdAt: new Date().toISOString()
            };
            state.folders.push(folder);
            state.expandedFolders[folder.id] = true;
            state.editingFolderId = folder.id;
            saveState();
            renderChatList();
            
            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const input = document.querySelector(`input[data-folder-id="${folder.id}"]`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }

        function toggleFolder(folderId, event) {
            event.stopPropagation();
            state.expandedFolders[folderId] = !state.expandedFolders[folderId];
            saveState();
            renderChatList();
        }

        function startEditFolder(folderId, event) {
            event.stopPropagation();
            state.editingFolderId = folderId;
            renderChatList();
            setTimeout(() => {
                const input = document.querySelector(`input[data-folder-id="${folderId}"]`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }

        function saveFolderName(folderId, event) {
            const newName = event.target.value.trim();
            if (newName) {
                const folder = state.folders.find(f => f.id === folderId);
                if (folder) {
                    folder.name = newName;
                }
            }
            state.editingFolderId = null;
            saveState();
            renderChatList();
        }

        function handleFolderKeyDown(folderId, event) {
            if (event.key === 'Enter') {
                saveFolderName(folderId, event);
            } else if (event.key === 'Escape') {
                state.editingFolderId = null;
                renderChatList();
            }
        }

        function deleteFolder(folderId, event) {
            event.stopPropagation();
            const folder = state.folders.find(f => f.id === folderId);
            const chatsInFolder = state.chats.filter(c => c.folderId === folderId);
            
            if (chatsInFolder.length > 0) {
                if (!confirm(`æ–‡ä»¶å¤¹"${folder.name}"ä¸­æœ‰${chatsInFolder.length}ä¸ªå¯¹è¯ï¼Œåˆ é™¤åå¯¹è¯å°†ç§»åˆ°æ ¹ç›®å½•ã€‚ç¡®å®šåˆ é™¤ï¼Ÿ`)) {
                    return;
                }
                // å°†æ–‡ä»¶å¤¹ä¸­çš„å¯¹è¯ç§»åˆ°æ ¹ç›®å½•
                chatsInFolder.forEach(c => c.folderId = null);
            }
            
            state.folders = state.folders.filter(f => f.id !== folderId);
            delete state.expandedFolders[folderId];
            saveState();
            renderChatList();
        }

        // å¯¹è¯ç®¡ç†
        function createNewChat() {
            const chat = {
                id: Date.now().toString(),
                title: generateChatTitle(),
                messages: [],
                folderId: null,
                createdAt: new Date().toISOString()
            };
            state.chats.unshift(chat);
            state.currentChatId = chat.id;
            saveState();
            renderChatList();
            renderChatArea();
        }

        function selectChat(chatId) {
            state.currentChatId = chatId;
            saveState();
            renderChatList();
            renderChatArea();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            if (state.chats.length === 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªå¯¹è¯');
                return;
            }
            state.chats = state.chats.filter(c => c.id !== chatId);
            if (state.currentChatId === chatId) {
                state.currentChatId = state.chats[0].id;
            }
            saveState();
            renderChatList();
            renderChatArea();
        }

        function getCurrentChat() {
            return state.chats.find(c => c.id === state.currentChatId);
        }

        function updateChatTitle(chat) {
            // ä¸å†è‡ªåŠ¨æ›´æ–°æ ‡é¢˜ï¼Œä¿æŒæ—¶é—´å‘½å
            // ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘æ ‡é¢˜
        }

        // ç”Ÿæˆæ—¶é—´æ ¼å¼çš„å¯¹è¯æ ‡é¢˜
        function generateChatTitle() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // ç¼–è¾‘å¯¹è¯æ ‡é¢˜
        function startEditChatTitle(chatId, event) {
            event.stopPropagation();
            state.editingChatId = chatId;
            renderChatList();
            setTimeout(() => {
                const input = document.querySelector(`input[data-chat-id="${chatId}"]`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }

        function saveChatTitle(chatId, event) {
            const newTitle = event.target.value.trim();
            if (newTitle) {
                const chat = state.chats.find(c => c.id === chatId);
                if (chat) {
                    chat.title = newTitle;
                }
            }
            state.editingChatId = null;
            saveState();
            renderChatList();
        }

        function handleChatTitleKeyDown(chatId, event) {
            if (event.key === 'Enter') {
                saveChatTitle(chatId, event);
            } else if (event.key === 'Escape') {
                state.editingChatId = null;
                renderChatList();
            }
        }

        // ç§»åŠ¨å¯¹è¯
        function openMoveModal(chatId, event) {
            event.stopPropagation();
            state.movingChatId = chatId;
            state.selectedMoveTarget = null;
            renderMoveModal();
            document.getElementById('moveModal').style.display = 'flex';
        }

        function closeMoveModal() {
            document.getElementById('moveModal').style.display = 'none';
            state.movingChatId = null;
            state.selectedMoveTarget = null;
        }

        function renderMoveModal() {
            const modalList = document.getElementById('moveModalList');
            const currentChat = state.chats.find(c => c.id === state.movingChatId);
            const currentFolderId = currentChat ? currentChat.folderId : null;

            let html = `<div class="move-modal-item ${currentFolderId === null ? 'active' : ''}" onclick="selectMoveTarget(null)">æ ¹ç›®å½•</div>`;
            
            state.folders.forEach(folder => {
                const isActive = currentFolderId === folder.id ? 'active' : '';
                html += `<div class="move-modal-item ${isActive}" onclick="selectMoveTarget('${folder.id}')">${escapeHtml(folder.name)}</div>`;
            });

            modalList.innerHTML = html;
        }

        function selectMoveTarget(folderId) {
            state.selectedMoveTarget = folderId;
            renderMoveModal();
        }

        function confirmMove() {
            if (state.movingChatId) {
                const chat = state.chats.find(c => c.id === state.movingChatId);
                if (chat) {
                    chat.folderId = state.selectedMoveTarget;
                    saveState();
                    renderChatList();
                }
            }
            closeMoveModal();
        }

        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            
            let html = '<button class="new-folder-btn" onclick="createNewFolder()"><i class="fas fa-folder-plus"></i> æ–°å»ºæ–‡ä»¶å¤¹</button>';

            // æ¸²æŸ“æ–‡ä»¶å¤¹åŠå…¶å¯¹è¯
            state.folders.forEach(folder => {
                const isExpanded = state.expandedFolders[folder.id];
                const isEditing = state.editingFolderId === folder.id;
                const folderChats = state.chats.filter(c => c.folderId === folder.id);

                html += `
                    <div class="folder-section">
                        <div class="folder-header" onclick="toggleFolder('${folder.id}', event)">
                            <span class="folder-icon ${isExpanded ? 'expanded' : ''}">â–¶</span>
                            ${isEditing ? `
                                <input type="text" class="folder-name-input" data-folder-id="${folder.id}" 
                                       value="${escapeHtml(folder.name)}" 
                                       onblur="saveFolderName('${folder.id}', event)"
                                       onkeydown="handleFolderKeyDown('${folder.id}', event)"
                                       onclick="event.stopPropagation()">
                            ` : `
                                <span class="folder-name" ondblclick="startEditFolder('${folder.id}', event)">${escapeHtml(folder.name)}</span>
                            `}
                            <div class="folder-actions">
                                <button class="folder-btn" onclick="startEditFolder('${folder.id}', event)">âœ</button>
                                <button class="folder-btn delete" onclick="deleteFolder('${folder.id}', event)">ğŸ—‘</button>
                            </div>
                        </div>
                        <div class="folder-chats ${isExpanded ? 'expanded' : ''}">
                            ${folderChats.map(chat => renderChatItem(chat)).join('')}
                        </div>
                    </div>
                `;
            });

            // æ¸²æŸ“ä¸åœ¨æ–‡ä»¶å¤¹ä¸­çš„å¯¹è¯
            const rootChats = state.chats.filter(c => !c.folderId);
            if (rootChats.length > 0) {
                html += '<div style="margin-top: 10px; padding-left: 5px; color: #7f8c8d; font-size: 12px;">æœªåˆ†ç±»å¯¹è¯</div>';
                rootChats.forEach(chat => {
                    html += renderChatItem(chat);
                });
            }

            chatList.innerHTML = html;
        }

        // æ¸²æŸ“å•ä¸ªå¯¹è¯é¡¹
        function renderChatItem(chat) {
            const isActive = chat.id === state.currentChatId;
            const isEditing = state.editingChatId === chat.id;

            return `
                <div class="chat-item ${isActive ? 'active' : ''}" onclick="selectChat('${chat.id}')">
                    ${isEditing ? `
                        <input type="text" class="chat-item-title-input" data-chat-id="${chat.id}" 
                               value="${escapeHtml(chat.title)}" 
                               onblur="saveChatTitle('${chat.id}', event)"
                               onkeydown="handleChatTitleKeyDown('${chat.id}', event)"
                               onclick="event.stopPropagation()">
                    ` : `
                        <span class="chat-item-title" ondblclick="startEditChatTitle('${chat.id}', event)">${escapeHtml(chat.title)}</span>
                    `}
                    <div class="chat-item-actions">
                        <button class="chat-btn" onclick="openMoveModal('${chat.id}', event)" title="ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹">ğŸ“</button>
                        <button class="chat-btn delete" onclick="deleteChat('${chat.id}', event)" title="åˆ é™¤å¯¹è¯">ğŸ—‘</button>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“å¯¹è¯åŒºåŸŸ
        function renderChatArea() {
            const chatArea = document.getElementById('chatArea');
            const chat = getCurrentChat();

            if (!chat || chat.messages.length === 0) {
                chatArea.innerHTML = `
                    <div class="welcome-message">
                        <h2>æ¬¢è¿ä½¿ç”¨AIè¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹</h2>
                        <p>ä¸Šä¼ æ‚¨çš„æ•™ææ–‡ä»¶ï¼ˆMarkdown/LaTeX/PDFï¼‰ï¼Œæˆ‘å°†åŸºäºæ•™æå†…å®¹ä¸ºæ‚¨ç­”ç–‘è§£æƒ‘</p>
                        <p>PDFå¤§å°é™åˆ¶50MB,å›¾ç‰‡é™åˆ¶10MB,å…¶ä»–æ–‡ä»¶å¤§å°é™åˆ¶5MB</p>
                        <p>æ‚¨å¯ä»¥ä¸Šä¼ é¢˜ç›®å›¾ç‰‡æˆ–è¾“å…¥é—®é¢˜ï¼Œé€‰æ‹©ä¸åŒåŠŸèƒ½è·å–å¸®åŠ©ï¼š</p>
                        <p><strong>æç¤º</strong> - ç»™å‡ºè§£é¢˜æ€è·¯ï¼Œä¸ç›´æ¥ç»™ç­”æ¡ˆ</p>
                        <p><strong>æ‰¹æ”¹</strong> - æ£€æŸ¥æ‚¨çš„ç­”æ¡ˆï¼ŒæŒ‡å‡ºé”™è¯¯å¹¶è®²è§£</p>
                        <p><strong>ç”Ÿé¢˜</strong> - ç”Ÿæˆç±»ä¼¼çš„ç»ƒä¹ é¢˜ç›®</p>
                        <p><strong>è‡ªç”±é—®</strong> - è‡ªç”±æé—®ä»»ä½•å­¦ä¹ é—®é¢˜</p>
                    </div>
                `;
                return;
            }

            chatArea.innerHTML = chat.messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-avatar">${msg.role === 'user' ? 'æˆ‘' : 'AI'}</div>
                    <div class="message-content">
                        ${msg.image ? `<img src="${msg.image}" alt="ä¸Šä¼ çš„å›¾ç‰‡">` : ''}
                        ${msg.role === 'assistant' ? renderMarkdown(msg.text) : escapeHtml(msg.text || '')}
                    </div>
                </div>
            `).join('');

            // æ¸²æŸ“LaTeXå…¬å¼
            renderLatex(chatArea);

            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // æ•™æç®¡ç†
        async function handleTextbookUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // PDFæ–‡ä»¶é™åˆ¶50MBï¼Œå…¶ä»–æ–‡ä»¶é™åˆ¶5MB
            const isPDF = file.name.toLowerCase().endsWith('.pdf');
            const maxSize = isPDF ? 50 * 1024 * 1024 : 5 * 1024 * 1024;
            
            if (file.size > maxSize) {
                alert(isPDF ? 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB' : 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                event.target.value = '';
                return;
            }

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const textbookList = document.getElementById('textbookList');
            const loadingHtml = '<span class="textbook-empty">æ­£åœ¨è§£ææ–‡ä»¶...</span>';
            if (state.textbooks.length === 0) {
                textbookList.innerHTML = loadingHtml;
            }

            try {
                let content = '';
                
                if (isPDF) {
                    // è§£æPDFæ–‡ä»¶
                    content = await extractPDFText(file);
                } else {
                    // è¯»å–æ–‡æœ¬æ–‡ä»¶
                    content = await readTextFile(file);
                }

                const textbook = {
                    id: Date.now().toString(),
                    name: file.name,
                    content: content
                };
                state.textbooks.push(textbook);
                saveState();
                renderTextbooks();
            } catch (error) {
                console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
                alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
                renderTextbooks();
            }
            
            event.target.value = '';
        }

        // è¯»å–æ–‡æœ¬æ–‡ä»¶
        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsText(file);
            });
        }

        // æå–PDFæ–‡æœ¬å†…å®¹
        async function extractPDFText(file) {
            // è®¾ç½®PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            const maxPages = Math.min(pdf.numPages, 500); // é™åˆ¶æœ€å¤š500é¡µ
            
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            if (pdf.numPages > 500) {
                fullText += '\n[æ³¨ï¼šPDFå…±' + pdf.numPages + 'é¡µï¼Œä»…æå–å‰500é¡µå†…å®¹]';
            }
            
            return fullText.trim();
        }

        function removeTextbook(id) {
            state.textbooks = state.textbooks.filter(t => t.id !== id);
            saveState();
            renderTextbooks();
        }

        function renderTextbooks() {
            const container = document.getElementById('textbookList');
            if (state.textbooks.length === 0) {
                container.innerHTML = '<span class="textbook-empty">æš‚æœªä¸Šä¼ æ•™æï¼Œä¸Šä¼ åAIå°†åŸºäºæ•™æå†…å®¹è¿›è¡Œè®²è§£</span>';
                return;
            }
            container.innerHTML = state.textbooks.map(tb => `
                <div class="textbook-item">
                    <span>${escapeHtml(tb.name)}</span>
                    <button class="textbook-item-remove" onclick="removeTextbook('${tb.id}')">Ã—</button>
                </div>
            `).join('');
        }

        // å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // é™åˆ¶å›¾ç‰‡å¤§å°ï¼ˆæœ€å¤§10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                state.currentImage = e.target.result;
                renderImagePreview();
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function removeCurrentImage() {
            state.currentImage = null;
            renderImagePreview();
        }

        function renderImagePreview() {
            const preview = document.getElementById('inputPreview');
            if (state.currentImage) {
                preview.innerHTML = `
                    <div class="preview-image">
                        <img src="${state.currentImage}" alt="é¢„è§ˆ">
                        <button class="preview-image-remove" onclick="removeCurrentImage()">Ã—</button>
                    </div>
                `;
            } else {
                preview.innerHTML = '';
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage(action) {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();
            const image = state.currentImage;

            if (!text && !image) {
                alert('è¯·è¾“å…¥é—®é¢˜æˆ–ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            if (state.isLoading) return;

            const chat = getCurrentChat();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = {
                role: 'user',
                text: text,
                image: image,
                action: action
            };
            chat.messages.push(userMessage);
            updateChatTitle(chat);

            // æ¸…ç©ºè¾“å…¥
            textInput.value = '';
            state.currentImage = null;
            renderImagePreview();
            
            // æ¸²æŸ“å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            renderChatArea();
            setLoading(true);

            // æ„å»ºç³»ç»Ÿæç¤º
            const systemPrompt = buildSystemPrompt(action);
            
            // æ„å»ºç”¨æˆ·æ¶ˆæ¯å†…å®¹
            const userContent = [];
            if (image) {
                userContent.push({
                    type: 'image_url',
                    image_url: { url: image }
                });
            }
            userContent.push({
                type: 'text',
                text: text || 'è¯·æŸ¥çœ‹å›¾ç‰‡ä¸­çš„å†…å®¹'
            });

            // æ„å»ºæ¶ˆæ¯å†å²
            const messages = [
                { role: 'system', content: systemPrompt }
            ];

            // æ·»åŠ æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆæœ€å¤š5è½®ï¼‰
            const recentMessages = chat.messages.slice(-21, -1);
            for (const msg of recentMessages) {
                if (msg.role === 'user') {
                    const content = [];
                    if (msg.image) {
                        content.push({ type: 'image_url', image_url: { url: msg.image } });
                    }
                    content.push({ type: 'text', text: msg.text || 'è¯·æŸ¥çœ‹å›¾ç‰‡' });
                    messages.push({ role: 'user', content });
                } else {
                    messages.push({ role: 'assistant', content: msg.text });
                }
            }

            // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
            messages.push({ role: 'user', content: userContent });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + API_KEY
                    },
                    body: JSON.stringify({
                        model: 'Qwen/Qwen3-VL-30B-A3B-Instruct',
                        messages: messages,
                        max_tokens: 16384,
                        temperature: 0.7,
                        enable_thinking: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const assistantText = data.choices[0].message.content;

                // æ·»åŠ åŠ©æ‰‹å›å¤
                chat.messages.push({
                    role: 'assistant',
                    text: assistantText
                });
                saveState();

                // ä¿å­˜é—®é¢˜è®°å½•åˆ°é—®é¢˜å›é¡¾
                saveQuestionRecord(text, image, assistantText, action);

            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                chat.messages.push({
                    role: 'assistant',
                    text: 'æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥äº†ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message
                });
                saveState();
            }

            setLoading(false);
            renderChatArea();
        }

        // æ„å»ºç³»ç»Ÿæç¤º
        function buildSystemPrompt(action) {
            let basePrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIè¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹ï¼Œå¸®åŠ©å­¦ç”Ÿç†è§£å’ŒæŒæ¡å­¦ç§‘çŸ¥è¯†ã€‚è¯·ç”¨æ¸…æ™°ã€æ˜“æ‡‚çš„è¯­è¨€å›ç­”é—®é¢˜ã€‚
            
å¦‚æœå­¦ç”Ÿä¸Šä¼ äº†å›¾ç‰‡ï¼Œè¯·ä»”ç»†åˆ†æå›¾ç‰‡ä¸­çš„å†…å®¹ï¼ˆå¦‚é¢˜ç›®ã€å…¬å¼ã€å›¾è¡¨ç­‰ï¼‰ã€‚`;

            // æ·»åŠ æ•™æå†…å®¹
            if (state.textbooks.length > 0) {
                basePrompt += '\n\nä»¥ä¸‹æ˜¯å­¦ç”Ÿä¸Šä¼ çš„å‚è€ƒæ•™æå†…å®¹ï¼Œè¯·åŸºäºè¿™äº›å†…å®¹è¿›è¡Œè®²è§£ï¼š\n';
                for (const tb of state.textbooks) {
                    basePrompt += `\nã€${tb.name}ã€‘\n${tb.content.slice(0, 3000)}\n`;
                }
            }

            // æ ¹æ®ä¸åŒæ“ä½œæ·»åŠ ç‰¹å®šæŒ‡ä»¤
            switch (action) {
                case 'hint':
                    basePrompt += `\n\nã€å½“å‰ä»»åŠ¡ï¼šç»™å‡ºæç¤ºã€‘
è¯·åˆ†æå­¦ç”Ÿçš„é—®é¢˜ï¼Œç»™å‡ºè§£é¢˜æ€è·¯å’Œæç¤ºï¼Œä½†ä¸è¦ç›´æ¥ç»™å‡ºå®Œæ•´ç­”æ¡ˆã€‚
- æŒ‡å‡ºå…³é”®çŸ¥è¯†ç‚¹
- æä¾›è§£é¢˜æ­¥éª¤çš„æ€è·¯
- å¼•å¯¼å­¦ç”Ÿè‡ªå·±æ€è€ƒ
- å¦‚æœæ˜¯è®¡ç®—é¢˜ï¼Œå¯ä»¥ç»™å‡ºç¬¬ä¸€æ­¥æˆ–å…³é”®æ­¥éª¤çš„æç¤º`;
                    break;
                case 'correct':
                    basePrompt += `\n\nã€å½“å‰ä»»åŠ¡ï¼šæ‰¹æ”¹ç­”æ¡ˆã€‘
è¯·ä»”ç»†æ£€æŸ¥å­¦ç”Ÿçš„ç­”æ¡ˆæˆ–è§£é¢˜è¿‡ç¨‹ï¼š
- æŒ‡å‡ºæ­£ç¡®çš„éƒ¨åˆ†ï¼Œç»™äºˆè‚¯å®š
- æ˜ç¡®æŒ‡å‡ºé”™è¯¯çš„åœ°æ–¹
- è§£é‡Šé”™è¯¯çš„åŸå› 
- ç»™å‡ºæ­£ç¡®çš„è§£ç­”æ–¹æ³•
- æä¾›ç›¸å…³çŸ¥è¯†ç‚¹çš„å¤ä¹ å»ºè®®`;
                    break;
                case 'generate':
                    basePrompt += `\n\nã€å½“å‰ä»»åŠ¡ï¼šç”Ÿæˆç»ƒä¹ é¢˜ã€‘
è¯·æ ¹æ®å­¦ç”Ÿçš„é—®é¢˜ï¼Œç”Ÿæˆç±»ä¼¼çš„ç»ƒä¹ é¢˜ç›®ï¼š
- ç”Ÿæˆ2-3é“åŒç±»å‹ã€ç›¸ä¼¼éš¾åº¦çš„é¢˜ç›®
- ç¡®ä¿é¢˜ç›®è¦†ç›–ç›¸åŒçš„çŸ¥è¯†ç‚¹
- å¯ä»¥é€‚å½“å˜æ¢æ•°å€¼æˆ–æƒ…å¢ƒ
- æœ€åç»™å‡ºè¿™äº›é¢˜ç›®çš„å‚è€ƒç­”æ¡ˆï¼ˆå¯ä»¥æŠ˜å æˆ–æ”¾åœ¨æœ€åï¼‰`;
                    break;
                case 'ask':
                default:
                    basePrompt += `\n\nã€å½“å‰ä»»åŠ¡ï¼šè‡ªç”±é—®ç­”ã€‘
è¯·æ ¹æ®å­¦ç”Ÿçš„é—®é¢˜è¿›è¡Œè¯¦ç»†è§£ç­”ï¼š
- æ¸…æ™°è§£é‡Šç›¸å…³æ¦‚å¿µ
- å¦‚æœæ˜¯é¢˜ç›®ï¼Œç»™å‡ºå®Œæ•´çš„è§£ç­”è¿‡ç¨‹
- ç»“åˆæ•™æå†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰è¿›è¡Œè®²è§£
- å¯ä»¥é€‚å½“æ‰©å±•ç›¸å…³çŸ¥è¯†`;
                    break;
            }

            return basePrompt;
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(loading) {
            state.isLoading = loading;
            const buttons = ['btnHint', 'btnCorrect', 'btnGenerate', 'btnAsk'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = loading;
            });

            if (loading) {
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML += `
                    <div class="message assistant" id="loadingMessage">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            <div class="loading">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                `;
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage('ask');
            }
        }

        // å·¥å…·å‡½æ•°ï¼šHTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç®€å•çš„Markdownæ¸²æŸ“ï¼ˆä¿ç•™LaTeXå…¬å¼ï¼‰
        function renderMarkdown(text) {
            if (!text) return '';
            
            // å…ˆä¿æŠ¤LaTeXå…¬å¼ï¼Œé¿å…è¢«HTMLè½¬ä¹‰ç ´å
            const latexBlocks = [];
            const latexInlines = [];
            
            // ä¿æŠ¤å—çº§å…¬å¼ $$...$$
            text = text.replace(/\$\$([\s\S]+?)\$\$/g, (match, p1) => {
                latexBlocks.push(p1);
                return `%%LATEX_BLOCK_${latexBlocks.length - 1}%%`;
            });
            
            // ä¿æŠ¤è¡Œå†…å…¬å¼ $...$ï¼ˆä½†ä¸åŒ¹é…å•ç‹¬çš„$ç¬¦å·ï¼‰
            text = text.replace(/\$([^\$\n]+?)\$/g, (match, p1) => {
                latexInlines.push(p1);
                return `%%LATEX_INLINE_${latexInlines.length - 1}%%`;
            });
            
            // ä¿æŠ¤ \[...\] å—çº§å…¬å¼
            text = text.replace(/\\\[([\s\S]+?)\\\]/g, (match, p1) => {
                latexBlocks.push(p1);
                return `%%LATEX_BLOCK_${latexBlocks.length - 1}%%`;
            });
            
            // ä¿æŠ¤ \(...\) è¡Œå†…å…¬å¼
            text = text.replace(/\\\(([\s\S]+?)\\\)/g, (match, p1) => {
                latexInlines.push(p1);
                return `%%LATEX_INLINE_${latexInlines.length - 1}%%`;
            });
            
            let html = escapeHtml(text);
            
            // ä»£ç å—
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // è¡Œå†…ä»£ç 
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // æ ‡é¢˜
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // ç²—ä½“å’Œæ–œä½“
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // åˆ—è¡¨
            html = html.replace(/^\- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
            
            // æ¢è¡Œ
            html = html.replace(/\n/g, '<br>');
            
            // æ¢å¤å—çº§LaTeXå…¬å¼
            latexBlocks.forEach((latex, i) => {
                html = html.replace(`%%LATEX_BLOCK_${i}%%`, `<div class="katex-block">$$${latex}$$</div>`);
            });
            
            // æ¢å¤è¡Œå†…LaTeXå…¬å¼
            latexInlines.forEach((latex, i) => {
                html = html.replace(`%%LATEX_INLINE_${i}%%`, `$${latex}$`);
            });
            
            return html;
        }
        
        // æ¸²æŸ“LaTeXå…¬å¼
        function renderLatex(element) {
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false,
                    output: 'html'
                });
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        document.getElementById('textInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>
